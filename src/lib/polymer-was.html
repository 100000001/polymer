<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<script>
(function() {

  Polymer.Was = {

    beforeRegister: function() {
      // was-ables may duplicate this behavior so this will be called 
      // multiple times, but the work need only be done once so bail if 
      // already was'd.
      if (this.__wased) {
        return;
      }

      for (var i in Polymer.Base._behaviorProperties) {
        // NOTE: hasOwnProperty goes away if this is not a behavior.
        if (!this.hasOwnProperty(i)) {
          this[i] = null;
        }
      }

      if (this.was) {
        var wasProto = this._getWas(this.was);
        if (wasProto) {
          // setup __behaviorMethods
          this.__behaviorMethods = this.behaviors.concat(
            wasProto.__behaviorMethods || wasProto.behaviors);
          // chain proto to was...
          Polymer.Base.chainObject(this, wasProto);
          // chain behaviors from was
          var wasBehaviors = wasProto.behaviors.filter(function(p) {
            return p !== Polymer.Was;
          });
          wasBehaviors.push(wasProto);
          // collapsed list of: 
          // [ extended behaviors, extended element, this.behaviors ]
          this.behaviors = wasBehaviors.concat(this.behaviors);
        } else {
          console.warn(this.is, 'could not find extendable prototype for was ', 
            this.was);
        }
      }

      this.__wased = true;
      // We rebuild this memoized data from scratch so we eliminate 
      // the values mix'd in from the `was`
      this._aggregatedAttributes = null;
      this._propertyEffects = null;
    },

    // useful for calling super functions...
    // e.g. `this._getWas('x-extend').go.call(this);`
    _getWas: function(tag) {
      return Polymer.telemetry.getProto(tag);
    },

    _doBehavior: function(name, args) {
      var list = this.__behaviorMethods || this.behaviors;
      for (var i=0; i < list.length; i++) {
        this._invokeBehavior(list[i], name, args);
      }
      this._invokeBehavior(this, name, args);
    },

  };

})();
</script>
